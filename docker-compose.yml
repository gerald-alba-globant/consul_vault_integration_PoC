version: "3.3"
services:
  consul_server:
    build: ./consul
    container_name: badger
    ports:
      - 8500:8500
      - 8600:8600/udp
    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0 -dns-port=53 -recursor=127.0.0.11
    environment:
      - CONSUL_ALLOW_PRIVILEGED_PORTS=true
  consul_client:
    build: ./consul_client
    container_name: fox
    links:
      - "consul_server:consul_server"
    command: agent -node=client-1 -join=consul_server
  vault:
    build: ./vault
    container_name: vault
    volumes:
      - ./vault/config.json:/vault/config/config.json
      - ./vault/python-policy.hcl:/usr/python-policy.hcl
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
    command: vault server -config /vault/config/config.json
    cap_add:
      - IPC_LOCK
  counting_service:
    build: ./couting_service
    container_name: weasel
    links:
      - "consul_server:consul_server"
    ports:
      - 9001:9001
  python_app:
    build: ./python_app
    container_name: cat
    volumes: 
      - ./python_app:/src
    links:
      - "consul_server:consul_server"
      - "custom_redis:custom_redis"
    ports:
      - 5000:5000
  custom_redis:
    build: ./redis
    container_name: rabbit
  jenkins:
    build: ./jenkins
    container_name: jenkins
    links:
      - "vault:vault"
    ports:
      - 8080:8080
      - 50000:50000
